<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8' />
  <link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
  <link rel="icon" href="data:,">
  <style>
    body {
      margin: 40px 10px;
      padding: 0;
      font-family: monospace;
      letter-spacing: -0.05rem;
    }
    #calendar {
      max-width: 100vw;
      height: 100vh;
      margin: 0 auto;
    }
    #eventModal {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #fff;
      border: 1px solid #ccc;
      padding: 20px;
      z-index: 1000;
      display: none;
    }
    #eventModal input, #eventModal select {
      margin: 5px 0;
      display: block;
    }
    #colorPreview {
      width: 100%;
      height: 30px;
      margin-top: 5px;
      border: 1px solid #ccc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #modalBackdrop {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      z-index: 999;
    }
  </style>
</head>
<body>

  <div id='calendar'></div>

  <div id="modalBackdrop"></div>
  <div id="eventModal">
    <label>Class Name: <input type="text" id="modalTitle" /></label>
    <label>Start Time: <input type="time" id="modalStartTime" /></label>
    <label>End Time: <input type="time" id="modalEndTime" /></label>
    <label>Repeat on Days:<br>
      <select id="modalDaysOfWeek" multiple>
        <option value="0">Sunday</option>
        <option value="1">Monday</option>
        <option value="2">Tuesday</option>
        <option value="3">Wednesday</option>
        <option value="4">Thursday</option>
        <option value="5">Friday</option>
        <option value="6">Saturday</option>
      </select>
    </label>
    <label>Background Color: <input type="color" id="modalColor" onchange="updatePreview()" /></label>
    <label>Text Color: <input type="color" id="modalTextColor" value="#ffffff" onchange="updatePreview()" /></label>
    <div id="colorPreview">Preview</div>
    <button id="saveBtn">Save</button>
    <button id="deleteBtn">Delete</button>
    <button id="cancelBtn">Cancel</button>
  </div>

  <script>
    let selectedEvent = null;
    let selectedInfo = null;

    document.addEventListener('DOMContentLoaded', function () {
      const calendarEl = document.getElementById('calendar');

      const defaultEvents = [
        { title: 'The Contemporary World', daysOfWeek: [5], startTime: '11:00', endTime: '14:30', color: '#007bff', textColor: '#ffffff' },
        { title: 'Euthenics', daysOfWeek: [5], startTime: '09:50', endTime: '10:50', color: '#28a745', textColor: '#ffffff' },
        { title: 'Fundamentals of Programming', daysOfWeek: [3], startTime: '11:00', endTime: '14:30', color: '#ffc107', textColor: '#000000' },
        { title: 'Introduction to Information Technology', daysOfWeek: [3], startTime: '14:30', endTime: '18:00', color: '#17a2b8', textColor: '#ffffff' },
        { title: 'Movement Competency Training/Fitness', daysOfWeek: [5], startTime: '14:45', endTime: '16:45', color: '#6f42c1', textColor: '#ffffff' },
        { title: 'Science, Technology, and Society', daysOfWeek: [2], startTime: '14:30', endTime: '18:00', color: '#fd7e14', textColor: '#000000' },
        { title: 'Understanding the Self', daysOfWeek: [2], startTime: '11:00', endTime: '14:30', color: '#dc3545', textColor: '#ffffff' }
      ];

      function generateRecurringEvents(rawEvents) {
        const recurring = [];
        for (const e of rawEvents) {
          if (e.daysOfWeek && e.startTime && e.endTime) {
            recurring.push({
              title: e.title,
              daysOfWeek: e.daysOfWeek,
              startTime: e.startTime,
              endTime: e.endTime,
              color: e.color,
              textColor: e.textColor,
              allDay: false
            });
          } else {
            recurring.push(e);
          }
        }
        return recurring;
      }

      const storedEvents = JSON.parse(localStorage.getItem('calendarEvents') || JSON.stringify(defaultEvents));

      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        slotDuration: '00:30:00',
        snapDuration: '00:05:00',
        allDaySlot: false,
        editable: true,
        selectable: true,
        nowIndicator: true,
        selectMirror: true,
        eventOverlap: true,
        slotMinTime: '00:00:00',
        slotMaxTime: '24:00:00',
        scrollTime: '00:00:00',
        slotLabelInterval: '01:00',
        slotLabelFormat: { hour: 'numeric', minute: '2-digit', hour12: true },
        height: 'auto',
        expandRows: true,
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'timeGridWeek,timeGridDay'
        },
        events: generateRecurringEvents(storedEvents),

        select(info) {
          selectedInfo = info;
          selectedEvent = null;
          document.getElementById('modalStartTime').value = info.start.toTimeString().slice(0, 5);
          document.getElementById('modalEndTime').value = info.end.toTimeString().slice(0, 5);
          openModal('', '#007bff', '#ffffff', []);
        },

        eventClick(info) {
          selectedEvent = info.event;
          selectedInfo = null;
          const startTime = selectedEvent.start.toTimeString().slice(0, 5);
          const endTime = selectedEvent.end.toTimeString().slice(0, 5);
          const days = selectedEvent.extendedProps.daysOfWeek || [];
          document.getElementById('modalStartTime').value = startTime;
          document.getElementById('modalEndTime').value = endTime;
          openModal(info.event.title, info.event.backgroundColor, info.event.textColor, days);
        }
      });

      function openModal(title, color, textColor, days) {
        document.getElementById('modalTitle').value = title;
        document.getElementById('modalColor').value = color;
        document.getElementById('modalTextColor').value = textColor;
        updatePreview();

        const daySelect = document.getElementById('modalDaysOfWeek');
        for (let option of daySelect.options) {
          option.selected = days.includes(parseInt(option.value));
        }

        document.getElementById('eventModal').style.display = 'block';
        document.getElementById('modalBackdrop').style.display = 'block';
      }

      function closeModal() {
        document.getElementById('eventModal').style.display = 'none';
        document.getElementById('modalBackdrop').style.display = 'none';
      }

      function saveModalEvent() {
        const title = document.getElementById('modalTitle').value;
        const color = document.getElementById('modalColor').value;
        const textColor = document.getElementById('modalTextColor').value;
        const start = document.getElementById('modalStartTime').value;
        const end = document.getElementById('modalEndTime').value;
        const daysOfWeek = Array.from(document.getElementById('modalDaysOfWeek').selectedOptions).map(o => parseInt(o.value));

        if (selectedEvent) {
          selectedEvent.remove();
        }

        if (selectedEvent || selectedInfo) {
          const baseDate = selectedEvent?.start || selectedInfo?.start;
          const baseDateStr = baseDate.toISOString().slice(0, 10);

          const newEvent = daysOfWeek.length
            ? { title, allDay: false, color, textColor, daysOfWeek, startTime: start, endTime: end }
            : { title, start: `${baseDateStr}T${start}`, end: `${baseDateStr}T${end}`, allDay: false, color, textColor };

          const currentEvents = JSON.parse(localStorage.getItem('calendarEvents') || '[]');
          currentEvents.push(newEvent);
          localStorage.setItem('calendarEvents', JSON.stringify(currentEvents));

          calendar.addEvent(newEvent);
        }

        closeModal();
      }

      function deleteModalEvent() {
        if (selectedEvent) {
          selectedEvent.remove();
        }
        closeModal();
        saveEvents();
      }

      function saveEvents() {
        const events = calendar.getEvents().map(event => ({
          title: event.title,
          allDay: event.allDay,
          color: event.backgroundColor,
          textColor: event.textColor,
          ...(event.extendedProps.daysOfWeek?.length
            ? {
                daysOfWeek: event.extendedProps.daysOfWeek,
                startTime: event.extendedProps.startTime || event.start?.toTimeString().slice(0,5),
                endTime: event.extendedProps.endTime || event.end?.toTimeString().slice(0,5)
              }
            : {
                start: event.startStr,
                end: event.endStr
              })
        }));
        localStorage.setItem('calendarEvents', JSON.stringify(events));
      }

      window.updatePreview = function () {
        const bg = document.getElementById('modalColor').value;
        const fg = document.getElementById('modalTextColor').value;
        const preview = document.getElementById('colorPreview');
        preview.style.backgroundColor = bg;
        preview.style.color = fg;
        preview.textContent = 'Preview';
      }

      document.getElementById("saveBtn").addEventListener("click", saveModalEvent);
      document.getElementById("deleteBtn").addEventListener("click", deleteModalEvent);
      document.getElementById("cancelBtn").addEventListener("click", closeModal);

      calendar.render();
    });
  </script>
</body>
</html>